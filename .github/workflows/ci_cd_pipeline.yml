name: CI/CD Pipeline

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  changes:
    name: Detect changed components
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      image_processor: ${{ steps.filter.outputs.image_processor }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Paths filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'frontend/**'
            image_processor:
              - 'image_processor/**'

  test-frontend:
    name: Test Frontend (React/Vite)
    runs-on: ubuntu-latest
    needs: changes
    if: github.event_name == 'pull_request' && needs.changes.outputs.frontend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
      - name: Run frontend tests
        run: |
          cd frontend
          npm test -- --run
      - name: Build frontend
        run: |
          cd frontend
          npm run build

  test-image-processor:
    name: Test Image Processor
    runs-on: ubuntu-latest
    needs: changes
    if: github.event_name == 'pull_request' && needs.changes.outputs.image_processor == 'true'
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: ${{ env.PGUSER }}
          POSTGRES_PASSWORD: ${{ env.PGPASSWORD }}
          POSTGRES_DB: ${{ env.PGDATABASE }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      rabbitmq:
        image: rabbitmq:3-alpine
        ports:
          - 5672:5672
        options: >-
          --health-cmd "rabbitmq-diagnostics ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      PGHOST: db
      PGPORT: 5432
      PGUSER: ${{ env.PGUSER }}
      PGPASSWORD: ${{ env.PGPASSWORD }}
      PGDATABASE: ${{ env.PGDATABASE }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Load .env variables
        run: |
          set -a
          source .env
          set +a
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install processor dependencies
        run: |
          cd image_processor
          pip install -r requirements.txt
      - name: Validate processor script
        run: |
          cd image_processor
          python -m py_compile processor.py
          echo "Image processor syntax is valid"

  build-push-frontend:
    name: Build & Push Frontend Docker
    runs-on: ubuntu-latest
    needs: test-frontend
    if: github.event_name == 'pull_request' && needs.changes.outputs.frontend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build Docker image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/frontend:latest ./frontend
      - name: Push Docker image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/frontend:latest

  build-push-image-processor:
    name: Build & Push Image Processor Docker
    runs-on: ubuntu-latest
    needs: test-image-processor
    if: github.event_name == 'pull_request' && needs.changes.outputs.image_processor == 'true'
    env:
      PGHOST: db
      PGPORT: 5432
      PGUSER: ${{ env.PGUSER }}
      PGPASSWORD: ${{ env.PGPASSWORD }}
      PGDATABASE: ${{ env.PGDATABASE }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Load .env variables
        run: |
          set -a
          source .env
          set +a
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build Docker image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/image_processor:latest ./image_processor
      - name: Push Docker image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/image_processor:latest

  build-push-rabbitmq:
    name: Build & Push RabbitMQ Docker
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Pull and Push RabbitMQ image
        run: |
          docker pull rabbitmq:3-alpine
          docker tag rabbitmq:3-alpine ${{ secrets.DOCKER_USERNAME }}/rabbitmq:3-alpine
          docker push ${{ secrets.DOCKER_USERNAME }}/rabbitmq:3-alpine

 
